<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>HTML Fetcher Widget</title>
</head>
<body>
  <div id="status">Waiting for URL...</div>

  <!-- Include Grist's Plugin API -->
  <script src="https://www.getgrist.com/grist-plugin-api.js"></script>

  <!-- Include the JavaScript code -->
  <script>
   // Let Grist know the widget is ready
   grist.ready({
    requiredAccess: 'full'
   grist.ready({columns: ['URL', 'Content']});
  });

// Listen for record changes
grist.onRecord(async (record, mappings) => {
  // Get the URL from the record
  let url = record.URL;
  let recordId = record.id;
  let tableId = mappings.tableId; // Get the table ID

  // Update the status in the widget
  let statusDiv = document.getElementById('status');

  if (url) {
    statusDiv.textContent = 'Fetching content...';
    try {
      // Fetch the HTML content from the URL
      let response = await fetch(url);

      if (response.ok) {
        let htmlContent = await response.text();

        statusDiv.textContent = 'Content fetched. Updating Grist...';

        // Get the Grist document API
        let docApi = await grist.docApi;

        // Update the 'Content' column in Grist
        await docApi.updateRecords(tableId, {
          id: [recordId],
          fields: {
            'Content': [htmlContent],
          }
        });

        statusDiv.textContent = 'Content updated successfully.';
      } else {
        statusDiv.textContent = 'Error fetching content: ' + response.statusText;
      }
    } catch (error) {
      statusDiv.textContent = 'Fetch error: ' + error.message;
    }
  } else {
    statusDiv.textContent = 'No URL provided.';
  }
});

  </script>
</body>
</html>
