<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Update Related Table</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script>
      // Function to update the related Times table
      async function updateTimes(htmlContent) {
        try {
          const response = await fetch("/update-times", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ htmlContent })
          });

          if (!response.ok) {
            throw new Error(`Failed to update Times: ${response.statusText}`);
          }
          console.log("Successfully updated Times record.");
        } catch (error) {
          console.error("Error updating Times record:", error);
        }
      }

      // Ready function to initialize the widget
      function ready(fn) {
        if (document.readyState !== "loading") {
          fn();
        } else {
          document.addEventListener("DOMContentLoaded", fn);
        }
      }

      ready(function () {
        grist.ready({
          columns: ["HtmlContent"], // Only need the HtmlContent column from EntryTable
          requiredAccess: "read table" // Minimal required access
        });

        grist.onRecord(function (record) {
          if (record && record.HtmlContent) {
            console.log("Detected HtmlContent update in EntryTable:", record.HtmlContent);
            updateTimes(record.HtmlContent); // Send updated HtmlContent to backend
          } else {
            console.warn("No HtmlContent detected in the updated EntryTable record.");
          }
        });
      });
    </script>
  </head>
  <body>
    <div>
      <h2>Updating Related Table</h2>
      <p>Listening for changes in EntryTable and updating Times table...</p>
    </div>
  </body>
</html>
