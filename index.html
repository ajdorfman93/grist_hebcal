<script>
  async function updateTimesFromEntry(entryTableRecord) {
    try {
      // Extract HtmlContent from EntryTable record
      const newHtmlContent = entryTableRecord.HtmlContent;

      if (!newHtmlContent) {
        console.warn("No HtmlContent found in the EntryTable record.");
        return;
      }

      // Fetch Times table
      const timesTable = await grist.docApi.fetchTable("Times");
      if (!timesTable || !timesTable.records.length) {
        console.warn("No records found in the Times table.");
        return;
      }

      // Find the top record in the Times table
      const topTimesRecord = timesTable.records.sort((a, b) => a.id - b.id)[0];

      if (topTimesRecord) {
        // Update the top record in Times table with the new HtmlContent
        const actions = [
          ["UpdateRecord", "Times", topTimesRecord.id, { HtmlContent: newHtmlContent }]
        ];
        await grist.docApi.applyUserActions(actions);
        console.log(`Updated Times record (ID: ${topTimesRecord.id}) with new HtmlContent.`);
      } else {
        console.warn("No valid record found in the Times table to update.");
      }
    } catch (error) {
      console.error("Error updating Times table:", error);
    }
  }

  // Monitor changes in the EntryTable and trigger the update function
  ready(function () {
    grist.ready({
      columns: ["HtmlContent"],
      requiredAccess: "full", // Ensure full access to update rows
    });

    grist.onRecord(function (entryRecord) {
      try {
        if (entryRecord && entryRecord.HtmlContent) {
          // Pass the EntryTable record to updateTimesFromEntry
          updateTimesFromEntry(entryRecord);
        } else {
          console.warn("No valid EntryTable record or HtmlContent found.");
        }
      } catch (err) {
        console.error("Error processing EntryTable record:", err);
      }
    });
  });
</script>
